<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketFit - Training Log</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#007bff">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="sticky">
            <div class="header-content">
                <h1>PocketFit</h1>
                <div class="header-actions">
                    <button id="menuToggle" class="icon-btn">‚ò∞</button>
                    <button id="themeToggle" class="icon-btn">üåô</button>
                </div>
            </div>
        </header>

        <!-- Sidebar Menu -->
        <div id="sideMenu" class="side-menu">
            <div class="menu-title">Navigation</div>
            <ul>
                <li><a href="#" data-target="workoutTab">üí™ Workouts</a></li>
                <li><a href="#" data-target="progressTab">üìà Progress</a></li>
                <li><a href="#" data-target="macrosTab">üçé Macros</a></li>
                <li><a href="#" data-target="communityTab">üë• Community</a></li>
                <li><a href="#" data-target="programTab">üìã Programs</a></li>
                <li><a href="#" data-target="lifestyleTab">üè† Pocketlifestyle</a></li>
                <li><a href="#" data-target="historyTab">üìö Log History</a></li>
                <li><a href="#" data-target="settingsTab">‚öôÔ∏è Settings</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Workout Tab -->
            <div id="workoutTab" class="tab-content active">
                <h2>Workout Log</h2>
                <div class="card">
                    <div class="inputs-grid">
                        <input type="text" id="exercise" placeholder="Exercise name" list="exerciseList">
                        <datalist id="exerciseList"></datalist>
                        <input type="number" id="sets" placeholder="Sets" min="1" max="10" value="3">
                        <input type="number" id="goal" placeholder="Target weight">
                        <input type="number" id="repGoal" placeholder="Target reps">
                        <select id="weightUnit">
                            <option value="kg">kg</option>
                            <option value="lbs">lbs</option>
                        </select>
                        <input type="date" id="entryDate">
                    </div>
                    <div id="setInputsContainer"></div>
                    <button id="addButton" onclick="addLogEntry()">Add Entry</button>
                </div>
                <div id="workoutList"></div>
            </div>

            <!-- Progress Tab -->
            <div id="progressTab" class="tab-content">
                <h2>Progress Tracking</h2>
                <div class="card">
                    <h3>Personal Records</h3>
                    <div id="prsList"></div>
                </div>
                <div class="card">
                    <h3>Milestones</h3>
                    <div id="milestonesList"></div>
                </div>
                <div class="card">
                    <h3>Goals</h3>
                    <div id="goalsList"></div>
                    <button onclick="addGoal()">Add Goal</button>
                </div>
            </div>

            <!-- Macros Tab -->
            <div id="macrosTab" class="tab-content">
                <h2>Macro Tracking</h2>
                <div id="macrosMainContent">
                    <div class="card">
                        <h3>Daily Progress</h3>
                        <div id="dailyMacroProgress"></div>
                    </div>
                    <div class="card">
                        <h3>Quick Add</h3>
                        <div class="quick-add">
                            <input type="number" id="qaProtein" placeholder="Protein (g)">
                            <button onclick="quickAdd('protein')">+ Protein</button>
                        </div>
                        <div class="quick-add">
                            <input type="number" id="qaCarbs" placeholder="Carbs (g)">
                            <button onclick="quickAdd('carbs')">+ Carbs</button>
                        </div>
                        <div class="quick-add">
                            <input type="number" id="qaFat" placeholder="Fat (g)">
                            <button onclick="quickAdd('fat')">+ Fat</button>
                        </div>
                    </div>
                </div>
                <div id="macrosSettingsContent" style="display: none;">
                    <div class="card">
                        <h3>Macro Targets</h3>
                        <label>Protein (g): <input type="number" id="proteinTarget"></label>
                        <label>Carbs (g): <input type="number" id="carbsTarget"></label>
                        <label>Fat (g): <input type="number" id="fatTarget"></label>
                        <button onclick="saveMacroTargets()">Save Targets</button>
                    </div>
                </div>
                <button id="adjustMacrosToggle" onclick="toggleTargetForm()">‚öôÔ∏è Adjust Macros</button>
            </div>

            <!-- Community Tab -->
            <div id="communityTab" class="tab-content">
                <h2>Community</h2>
                <div class="card">
                    <h3>Groups</h3>
                    <button onclick="showCreateGroup()">Create Group</button>
                    <div>
                        <input id="groupSearchInput" placeholder="Search groups">
                        <select id="goalFilter"><option value="">All Goals</option></select>
                        <select id="tagFilter"><option value="">All Tags</option></select>
                        <button onclick="doGroupSearch()">Search</button>
                    </div>
                    <div id="groupList"></div>
                </div>
                <div id="groupDetail" style="display: none;"></div>
            </div>

            <!-- Programs Tab -->
            <div id="programTab" class="tab-content">
                <h2>Training Programs</h2>
                <div id="programTabReactRoot"></div>
            </div>

            <!-- Lifestyle Tab -->
            <div id="lifestyleTab" class="tab-content">
                <h2>Pocketlifestyle</h2>
                <div class="lifestyle-nav">
                    <button data-ltab="dailyTab">Daily</button>
                    <button data-ltab="studyTab">Study</button>
                    <button data-ltab="todoTab">Tasks</button>
                    <button data-ltab="habitsTab">Habits</button>
                    <button data-ltab="goalsTab">Goals</button>
                </div>

                <!-- Daily Schedule Tab -->
                <div id="dailyTab" class="lifestyle-tab active">
                    <h3>Daily Schedule</h3>
                    <input type="date" id="scheduleDate">
                    <button onclick="openScheduleForm()">Add Item</button>
                    <ul id="scheduleList"></ul>
                </div>

                <!-- Study Sessions Tab -->
                <div id="studyTab" class="lifestyle-tab">
                    <h3>Study Sessions</h3>
                    <select id="subjectFilter"></select>
                    <button onclick="addSubject()">Add Subject</button>
                    <button onclick="openStudyForm()">Manual Entry</button>
                    <div>
                        <button id="studyTimerBtn" onclick="startStudySession()">Start Study Session</button>
                        <span id="studyTimerDisplay"></span>
                    </div>
                    <ul id="studyList"></ul>
                </div>

                <!-- Todo Tab -->
                <div id="todoTab" class="lifestyle-tab">
                    <h3>To-Do List</h3>
                    <select id="todoCategoryFilter"></select>
                    <button onclick="addTodoCategory()">Add Category</button>
                    <button onclick="openTodoForm()">Add Task</button>
                    <ul id="todoList"></ul>
                </div>

                <!-- Habits Tab -->
                <div id="habitsTab" class="lifestyle-tab">
                    <h3>Habits</h3>
                    <button onclick="addHabit()">Add Habit</button>
                    <ul id="habitsList"></ul>
                </div>

                <!-- Goals Tab -->
                <div id="goalsTab" class="lifestyle-tab">
                    <h3>Goals</h3>
                    <button onclick="addGoalCategory()">Add Goal</button>
                    <ul id="goalsList"></ul>
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <h2>Log History</h2>
                <div class="card">
                    <h3>Workout History</h3>
                    <div id="workoutHistory"></div>
                </div>
                <div class="card">
                    <h3>Archived Workouts</h3>
                    <div id="archivedWorkouts"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <h2>Settings</h2>
                <div class="card">
                    <h3>Account</h3>
                    <div id="loginSection">
                        <input type="text" id="username" placeholder="Username">
                        <input type="password" id="password" placeholder="Password">
                        <button onclick="startLogin()">Login</button>
                    </div>
                    <div id="userSection" style="display: none;">
                        <p>Logged in as: <span id="currentUserDisplay"></span></p>
                        <button onclick="logout()">Logout</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Theme</h3>
                    <select id="themeSelector">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="dark-blue">Dark Blue</option>
                    </select>
                </div>
                <div class="card">
                    <h3>Data Management</h3>
                    <button onclick="exportData()">Export Data</button>
                    <button onclick="importData()">Import Data</button>
                    <button onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button data-target="workoutTab">üí™</button>
            <button data-target="progressTab">üìà</button>
            <button data-target="macrosTab">üçé</button>
            <button data-target="communityTab">üë•</button>
            <button data-target="settingsTab">‚öôÔ∏è</button>
        </nav>
    </div>

    <!-- Toast notifications -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="archiveOldWorkouts.js"></script>
    <script src="calculateWorkoutVolume.js"></script>
    <script src="progressUtils.js"></script>
    <script src="progressMilestones.js"></script>
    <script src="progressAnalytics.js"></script>
    <script src="progressGoals.js"></script>
    <script src="progressAI.js"></script>
    <script src="gamification.js"></script>
    <script src="exerciseAutocomplete.js"></script>
    <script src="progressiveOverload.js"></script>
    <script src="autoProgression.js"></script>
    <script src="periodization.js" type="module"></script>
    <script src="macrosFeatures.js" type="module"></script>
    <script src="lifestyle.js"></script>
    <script src="offline.js" type="module"></script>
    <script src="community.js"></script>
    <script src="ProgramTab.js" type="module"></script>

    <script>
        // Global variables
        let currentUser = localStorage.getItem('currentUser') || null;
        let currentSetCount = 0;
        let currentTheme = localStorage.getItem('theme') || 'light';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            applyTheme(currentTheme);
            updateLoginUI();
            renderWorkouts();
            renderPRs();
            renderMilestones();
            loadGroups();
            if (window.initLifestyle) {
                initLifestyle();
            }
            renderHistory();
            renderSettings();
            
            // Set today's date as default
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            updateSetInputs();
        }

        function setupEventListeners() {
            // Menu toggle
            document.getElementById('menuToggle').addEventListener('click', toggleMenu);
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Tab navigation - sidebar
            document.querySelectorAll('#sideMenu a[data-target]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showTab(this.getAttribute('data-target'));
                    closeMenu();
                });
            });
            
            // Tab navigation - bottom nav
            document.querySelectorAll('.bottom-nav button[data-target]').forEach(button => {
                button.addEventListener('click', function() {
                    showTab(this.getAttribute('data-target'));
                });
            });
            
            // Sets input change
            document.getElementById('sets').addEventListener('change', updateSetInputs);
            
            // Theme selector
            document.getElementById('themeSelector').addEventListener('change', function() {
                applyTheme(this.value);
            });
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
                
                // Initialize tab-specific content
                switch(tabName) {
                    case 'lifestyleTab':
                        if (window.initLifestyle) {
                            initLifestyle();
                        }
                        break;
                    case 'historyTab':
                        renderHistory();
                        break;
                    case 'settingsTab':
                        renderSettings();
                        break;
                    case 'macrosTab':
                        renderDailyMacroProgress();
                        break;
                    case 'progressTab':
                        renderPRs();
                        renderMilestones();
                        break;
                    case 'communityTab':
                        loadGroups();
                        break;
                }
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            menu.classList.toggle('active');
        }

        function closeMenu() {
            const menu = document.getElementById('sideMenu');
            menu.classList.remove('active');
        }

        function toggleTheme() {
            const themes = ['light', 'dark', 'dark-blue'];
            const currentIndex = themes.indexOf(currentTheme);
            const nextTheme = themes[(currentIndex + 1) % themes.length];
            applyTheme(nextTheme);
        }

        function applyTheme(theme) {
            currentTheme = theme;
            document.body.className = theme + '-mode';
            localStorage.setItem('theme', theme);
            document.getElementById('themeSelector').value = theme;
            
            // Update theme toggle icon
            const themeIcon = document.getElementById('themeToggle');
            themeIcon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Workout functions
        function updateSetInputs() {
            const sets = parseInt(document.getElementById('sets').value) || 3;
            const container = document.getElementById('setInputsContainer');
            container.innerHTML = '';
            
            currentSetCount = sets;
            
            for (let i = 0; i < sets; i++) {
                const setDiv = document.createElement('div');
                setDiv.className = 'set-input';
                setDiv.innerHTML = `
                    <label>Set ${i + 1}:</label>
                    <input type="number" id="reps_${i}" placeholder="Reps" min="1">
                    <input type="number" id="weight_${i}" placeholder="Weight" step="0.5">
                `;
                container.appendChild(setDiv);
            }
            
            updateAddButtonState();
        }

        function updateAddButtonState() {
            const exercise = document.getElementById('exercise').value.trim();
            const button = document.getElementById('addButton');
            button.disabled = !exercise;
        }

        function addLogEntry() {
            const exercise = document.getElementById('exercise').value.trim();
            const sets = parseInt(document.getElementById('sets').value) || 3;
            const goal = parseFloat(document.getElementById('goal').value) || null;
            const repGoal = parseInt(document.getElementById('repGoal').value) || null;
            const unit = document.getElementById('weightUnit').value;
            const date = document.getElementById('entryDate').value;
            
            if (!exercise) {
                showToast('Please enter an exercise name');
                return;
            }
            
            const repsArray = [];
            const weightsArray = [];
            
            for (let i = 0; i < sets; i++) {
                const reps = parseInt(document.getElementById(`reps_${i}`).value) || 0;
                const weight = parseFloat(document.getElementById(`weight_${i}`).value) || 0;
                repsArray.push(reps);
                weightsArray.push(weight);
            }
            
            const entry = {
                exercise,
                repsArray,
                weightsArray,
                goal,
                repGoal,
                unit,
                timestamp: Date.now()
            };
            
            // Save to workouts
            const workoutsKey = `workouts_${currentUser}`;
            let workouts = JSON.parse(localStorage.getItem(workoutsKey)) || [];
            
            // Check if we need a new workout for this date
            const lastWorkout = workouts[workouts.length - 1];
            if (!lastWorkout || lastWorkout.date !== date) {
                workouts.push({
                    date,
                    title: `Workout ${new Date(date).toLocaleDateString()}`,
                    log: [entry]
                });
            } else {
                lastWorkout.log.push(entry);
            }
            
            localStorage.setItem(workoutsKey, JSON.stringify(workouts));
            
            // Update PRs and other tracking
            if (window.updatePRs) {
                updatePRs(currentUser, { log: [entry] }, calculateWorkoutVolume);
            }
            
            // Save exercise for autocomplete
            if (window.saveUserExercise) {
                saveUserExercise(exercise);
            }
            
            // Clear form
            document.getElementById('exercise').value = '';
            for (let i = 0; i < sets; i++) {
                document.getElementById(`reps_${i}`).value = '';
                document.getElementById(`weight_${i}`).value = '';
            }
            
            showToast('Entry added successfully!');
            renderWorkouts();
            renderPRs();
        }

        function renderWorkouts() {
            if (!currentUser) return;
            
            const workoutsKey = `workouts_${currentUser}`;
            const workouts = JSON.parse(localStorage.getItem(workoutsKey)) || [];
            const container = document.getElementById('workoutList');
            
            container.innerHTML = '';
            
            workouts.slice(-5).reverse().forEach(workout => {
                const workoutDiv = document.createElement('div');
                workoutDiv.className = 'card';
                
                let logHtml = '';
                workout.log.forEach(entry => {
                    logHtml += `
                        <div class="log-entry">
                            <strong>${entry.exercise}</strong>
                            <div>Sets: ${entry.repsArray.map((r, i) => `${r}x${entry.weightsArray[i]}${entry.unit}`).join(', ')}</div>
                        </div>
                    `;
                });
                
                workoutDiv.innerHTML = `
                    <h3>${workout.title}</h3>
                    <p>Date: ${workout.date}</p>
                    ${logHtml}
                `;
                
                container.appendChild(workoutDiv);
            });
        }

        function renderPRs() {
            if (!currentUser || !window.loadPRs) return;
            
            const prs = loadPRs(currentUser);
            const container = document.getElementById('prsList');
            
            container.innerHTML = '';
            
            Object.entries(prs).forEach(([exercise, data]) => {
                const prDiv = document.createElement('div');
                prDiv.innerHTML = `
                    <strong>${exercise}</strong>: ${data.oneRM.toFixed(1)} (1RM)
                `;
                container.appendChild(prDiv);
            });
        }

        function renderMilestones() {
            if (!currentUser || !window.checkMilestones) return;
            
            const workoutsKey = `workouts_${currentUser}`;
            const workouts = JSON.parse(localStorage.getItem(workoutsKey)) || [];
            const milestones = checkMilestones(currentUser, workouts, calculateWorkoutVolume);
            const container = document.getElementById('milestonesList');
            
            container.innerHTML = '';
            
            milestones.forEach(milestone => {
                const milestoneDiv = document.createElement('div');
                milestoneDiv.textContent = milestone;
                container.appendChild(milestoneDiv);
            });
        }

        function renderHistory() {
            if (!currentUser) return;
            
            const historyKey = `workoutHistory_${currentUser}`;
            const history = JSON.parse(localStorage.getItem(historyKey)) || [];
            const container = document.getElementById('workoutHistory');
            
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p>No workout history available.</p>';
                return;
            }
            
            history.slice(-10).reverse().forEach(workout => {
                const workoutDiv = document.createElement('div');
                workoutDiv.className = 'card';
                
                let logHtml = '';
                if (workout.log && workout.log.length > 0) {
                    workout.log.forEach(entry => {
                        logHtml += `
                            <div class="log-entry">
                                <strong>${entry.exercise}</strong>
                                <div>Sets: ${entry.repsArray.map((r, i) => `${r}x${entry.weightsArray[i]}${entry.unit}`).join(', ')}</div>
                            </div>
                        `;
                    });
                }
                
                workoutDiv.innerHTML = `
                    <h3>${workout.title}</h3>
                    <p>Date: ${workout.date}</p>
                    ${logHtml}
                `;
                
                container.appendChild(workoutDiv);
            });
        }

        function renderSettings() {
            const themeSelector = document.getElementById('themeSelector');
            themeSelector.value = currentTheme;
        }

        // Macro functions
        function renderDailyMacroProgress() {
            const progress = JSON.parse(localStorage.getItem('dailyMacroProgress')) || {
                protein: 0,
                carbs: 0,
                fats: 0,
                cals: 0
            };
            
            const targets = JSON.parse(localStorage.getItem(`macroTargets_${currentUser}`)) || {
                protein: 150,
                carbs: 200,
                fats: 70,
                calories: 2000
            };
            
            const container = document.getElementById('dailyMacroProgress');
            if (!container) return;
            
            container.innerHTML = `
                <div>Protein: ${progress.protein}g / ${targets.protein}g</div>
                <div>Carbs: ${progress.carbs}g / ${targets.carbs}g</div>
                <div>Fats: ${progress.fats}g / ${targets.fats}g</div>
                <div>Calories: ${progress.cals} / ${targets.calories}</div>
            `;
        }

        function saveMacroTargets() {
            const protein = parseInt(document.getElementById('proteinTarget').value) || 150;
            const carbs = parseInt(document.getElementById('carbsTarget').value) || 200;
            const fats = parseInt(document.getElementById('fatTarget').value) || 70;
            const calories = (protein * 4) + (carbs * 4) + (fats * 9);
            
            const targets = { protein, carbs, fats, calories };
            localStorage.setItem(`macroTargets_${currentUser}`, JSON.stringify(targets));
            
            showToast('Macro targets saved!');
            renderDailyMacroProgress();
        }

        // Auth functions
        async function startLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showToast('Please enter username and password');
                return;
            }
            
            try {
                const response = await fetch(`${window.SERVER_URL}/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = username;
                    localStorage.setItem('currentUser', currentUser);
                    updateLoginUI();
                    showToast('Login successful!');
                } else {
                    showToast('Login failed: ' + result.message);
                }
            } catch (error) {
                console.error('Login error:', error);
                // Fallback to local login
                currentUser = username;
                localStorage.setItem('currentUser', currentUser);
                updateLoginUI();
                showToast('Logged in locally');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateLoginUI();
            showToast('Logged out');
        }

        function updateLoginUI() {
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            const currentUserDisplay = document.getElementById('currentUserDisplay');
            
            if (currentUser) {
                loginSection.style.display = 'none';
                userSection.style.display = 'block';
                currentUserDisplay.textContent = currentUser;
            } else {
                loginSection.style.display = 'block';
                userSection.style.display = 'none';
            }
        }

        // Utility functions
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function addGoal() {
            const type = prompt('Goal type (e.g., "bench_press", "total_volume"):');
            const target = parseFloat(prompt('Target value:'));
            
            if (type && target && window.setGoal) {
                setGoal(currentUser, type, target);
                showToast('Goal added!');
            }
        }

        function exportData() {
            if (!currentUser) {
                showToast('Please login first');
                return;
            }
            
            const data = {};
            for (let key in localStorage) {
                if (key.includes(currentUser)) {
                    data[key] = localStorage.getItem(key);
                }
            }
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pocketfit_data_${currentUser}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            Object.entries(data).forEach(([key, value]) => {
                                localStorage.setItem(key, value);
                            });
                            showToast('Data imported successfully!');
                            location.reload();
                        } catch (error) {
                            showToast('Error importing data');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Make functions globally available
        window.showTab = showTab;
        window.addLogEntry = addLogEntry;
        window.startLogin = startLogin;
        window.logout = logout;
        window.saveMacroTargets = saveMacroTargets;
        window.addGoal = addGoal;
        window.exportData = exportData;
        window.importData = importData;
        window.clearAllData = clearAllData;
        window.currentUser = currentUser;
    </script>
</body>
</html>